<!--
 Polymer Custom Element representing peer in Puppet Opperational Transformation communication Visualization
 -->
<!-- Import Polymer -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- dependencies-->
<link rel="import" href="potv-operation.html">
<script src="../bower_components/json-patch-queue/src/json-patch-queue.js"></script>
<link rel="import" href="../bower_components/core-collapse/core-collapse.html">

<!-- Define your custom element -->
<polymer-element name="potv-peer" attributes="name json localVersion remoteVersion ackLocalVersion localVersionPath remoteVersionPath">
<template>
<style>
 :host{
    display: block;
    min-height: 20px;
    padding: 19px;
    margin-bottom: 20px;
    background-color: #f5f5f5;
    border: 1px solid #e3e3e3;
    border-radius: 4px;
    -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
    box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
 }
 h2{
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    font-weight: 500;
    color: rgb(255,203,0);
    font-size: 28px;
    line-height: 42px;
    margin: -8px 0 4px;
 }
 ::content>*{
    display: inline-block;
 }
 ::content>.potv-processed{
    transform: scale(0.8);
    /*float: left;*/
 }
 ul{
    list-style: none;
    padding-left: 10px;
 }
 h4,h5{
    cursor: pointer;
    margin-bottom: 2px;
 }
 #queue, #history, #pending{
    display: block;
    margin-bottom: 20px;
    border: 1px solid #e3e3e3;
    border-radius: 4px;
    -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
    box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);

 }
</style>
  <h2>{{name}}</h2>
  <ul>
    <li>Local version: {{localVersion}}</li>
    <li title="Supposedly, latest, local version acknowledged by remote">Local version acknowledged by remote: {{ackLocalVersion}}</li>
    <li>Acknowledged remote version: {{remoteVersion}}</li>
  </ul>
  <button disabled on-click="{{sendTest}}">Send test</button>
  <button on-click="{{bumpVersion}}">Bump version</button>
  <h4 on-click="{toggleQueue}}" title="List of operations that waits to be applied here.">Queue</h4>
  <core-collapse id="queue" allowOverflow opened>
    <content select=".potv-queue"></content>
  </core-collapse>
  <h5 on-click="{{togglePending}}" title="List of sent operations in unsure state. Possibly we would need to transfrom against them.">Pending </h5>
  <core-collapse id="pending" allowOverflow opened>
        <content select=".potv-pending"></content>
  </core-collapse>
  <h5 on-click="{{toggleHistory}}" title="List of operations successfully aplied here.">History</h5>
  <core-collapse id="history" allowOverflow opened>
        <content select=".potv-processed"></content>
  </core-collapse>
  <content></content>



</template>

    <script>
        /**
         * @TODO: isolate pot-peer for protocol stuff only
         */
        Polymer('potv-peer', {
            name: "",
            queue: null,
            opElementsQueue: null,
            localVersionPath: "/_localVersion",
            remoteVersionPath: "/_remoteVersion",
            diagram: null,
            // supposedly, latest, local version acknowledged by remote
            // in other words: zero/starting point in transformation calculation
            ackLocalVersion: 0,
            // list of local operations, that were potentially not yet acknowledged by remote
            nonAckList: [],
            
            // Fires when an instance of the element is created
            created: function() {
                this.queue = new JSONPatchQueue([this.localVersionPath, this.remoteVersionPath], this.applyPatch.bind(this), false);
                this.opElementsQueue = [];
                this.nonAckList = [];
                // this.potPeer = new pot.Peer();
            },

            // Fires when the elementâ€™s initial set of children and siblings are guaranteed to exist
            domReady: function() {},

            // Fires when the "<polymer-element>" has been fully prepared
            ready: function() {},

            // Fires when the element was inserted into the document
            attached: function() {},

            // Fires when the element was removed from the document
            detached: function() {},

            // sendTest: function (){
            //     this.dispatchEvent(new CustomEvent("testsent",{
            //         detail:{
            //             operation: new ot.JSONPatchOperation([], this.localVersion, this.remoteVersion, this.localVersionPath, this.remoteVersionPath)
            //         }
            //     }) );
            // },
            bumpVersion: function (){
                this.localVersion++;
                this.dispatchEvent(new CustomEvent("versionbumped",{
                    detail:{
                        operation: new ot.JSONPatchOperation([], this.localVersion, this.remoteVersion, this.localVersionPath, this.remoteVersionPath)
                    }
                }) );
            },

            localVersionPathChanged: function(oldVal, newVal){
                this.queue.localPath = newVal;
            },
            remoteVersionPathChanged: function(oldVal, newVal){
                this.queue.remotePath = newVal;
            },

            applyPatch: function(obj, remoteVersionedJsonPatch){
                console.log("applyPatch", this, arguments);
                // transforming / applying
                var consecutivePatch = remoteVersionedJsonPatch.slice(0);
                // 
                // shift first operation object as it should contain test for our local version.
                // ! We assume correct sequence structure, and queuing applied before.
                var localVersionAckByRemote = consecutivePatch.shift().value;

                // Latest local version acknowledged by remote
                // Thanks to the queue version may only be higher or equal to current.
                this.ackLocalVersion = localVersionAckByRemote;
                //clear pending operations
                this.removePendingOperationsWithLocalVersionLowerThan(this.ackLocalVersion);
                if(this.nonAckList.length){// is there any pending local operation?
                    // => Remote sent us something based on outdated versionDistance
                    console.info("Transformation needed", consecutivePatch, 'by', this.nonAckList);
                    var transformedOperation = ot.JSONPatchOperation.transform(
                            consecutivePatch,
                            this.nonAckList.map(function(el){return el.operation;})// fetch JSONPatchOperations out of <potv-operation>s
                        );

                }
                this.remoteVersion = this.queue.remoteVersion;
                try{
                    jsonpatch.apply(obj, transformedOperation && transformedOperation.ops || consecutivePatch);
                }catch (ex){
                    alert("jsonpatch.apply error:" + ex);
                }
                
                //Visualization stuff
                    var operationElement = this.opElementsQueue.shift();
                    // move ball out of queue
                    operationElement.classList.remove("potv-queue");
                    operationElement.classList.add("potv-processed");
                    // draw remote edge
                    var serverEdgeLength = this.remoteVersion - this.diagram.serverStatePoint.rightEdges;
                    // serverEdgeLength > 0 && this.diagram.goRightServer({length: serverEdgeLength});
                    // draw local edge
                    // this.diagram.goLeft();
                    // this.diagram.goRightClient();

                    // this.diagram.drawEdge([this.localVersion, this.remoteVersion], 'right', 1);

                    if( transformedOperation ){
                        this.diagram.drawEdge([localVersionAckByRemote, this.remoteVersion-1], 'right', 1);
                        this.diagram.drawEdge([this.localVersion, this.remoteVersion-1], 'right', 1, true);

                        var transformedOperationElement = document.createElement("potv-operation");
                        transformedOperationElement.classList.add("transformed", "potv-processed");
                        transformedOperationElement.setAttribute("author",operationElement.author + "+" + this.id);

                        transformedOperationElement.operation = new ot.JSONPatchOperation( 
                            transformedOperation, this.remoteVersion, this.localVersion, this.remoteVersionPath,this.localVersionPath);

                        transformedOperationElement.appendChild(operationElement);
                        // transformedOperationElement.appendChild( pendingOperations );
                        // clone also pending operations that were used for transformation
                        for(var nonAckNumber = 0, nonAckLength = this.nonAckList.length; nonAckNumber < nonAckLength; nonAckNumber++){
                            var pendingOperation = this.nonAckList[nonAckNumber];
                            var clonedPendingOperation = pendingOperation.cloneNode(true);
                            // clonedPendingOperation.operation = JSONPatchOperation.fromJSON( JSON.parse(JSON.stringify(pendingOperation.operation)) );
                            clonedPendingOperation.operation = ot.JSONPatchOperation.fromJSON( pendingOperation.operation.patch );
                            transformedOperationElement.appendChild(clonedPendingOperation);
                            this.diagram.drawEdge([pendingOperation.operation.localRevision - 1, this.remoteVersion], 'left', 1, true);
                        }


                        this.appendChild(transformedOperationElement);
                    } else {
                        this.diagram.drawEdge([this.localVersion, this.remoteVersion-1], 'right', 1);
                    }
   
            },

            recieve: function(operationElement){
                var operation = operationElement.operation;
                var transformedOperation = null;
                // visuals - replicate queue for DOM elements
                    operationElement.classList.add("potv-queue");
                    this.opElementsQueue[operation.localRevision - this.queue.remoteVersion -1] = (operationElement);
                    // draw queued edges
                    this.diagram.drawEdge([operation.remoteRevision, operation.localRevision -1], 'right', 1, false, '#ddd');
                    this.appendChild(operationElement);

                this.queue.receive(this.json, operation.patch);

                return this;
            },

            removePendingOperationsWithLocalVersionLowerThan: function(ackVersion){
                var arr = this.nonAckList;
                var len = arr.length;
                var opNo = 0;
                while(opNo < len && arr[opNo].operation.localRevision<=ackVersion){
                    opNo++
                }
                if(opNo){
                    var removedOperations = this.nonAckList.splice(0,opNo);
                
                    //Visualization stuff
                        var removedLen = removedOperations.length;
                        while(removedLen-- >0){
                            var opToRemove = removedOperations[removedLen];
                            opToRemove.parentNode.removeChild(opToRemove);
                        }
                }
            },

            send: function(sequence){
                var operationElement = document.createElement("potv-operation");
                operationElement.setAttribute("author",this.id);

                var versionedSequence = this.queue.send(sequence);
                this.localVersion = this.queue.localVersion;
                // redundant
                operationElement.operation = new ot.JSONPatchOperation(sequence, this.localVersion, this.remoteVersion, this.localVersionPath,this.remoteVersionPath);

                //TODO: instead of a copy, make it a reflection
                var pendingOperationElement = document.createElement("potv-operation");
                pendingOperationElement.operation = operationElement.operation;
                pendingOperationElement.classList.add("potv-pending");
                pendingOperationElement.setAttribute("author",this.id);
                this.nonAckList.push(pendingOperationElement);

                this.appendChild( pendingOperationElement );


                // this.diagram.goLeftClient();
                this.diagram.drawEdge([this.localVersion-1, this.remoteVersion], 'left', 1);
                return operationElement;

            },

            // ui only
            toggleHistory: function(){
                this.$.history.toggle();
            },
            toggleQueue: function(){
                this.$.queue.toggle();
            }
        });
    </script>

</polymer-element>